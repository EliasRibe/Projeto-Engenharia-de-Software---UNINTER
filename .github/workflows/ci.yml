name: SGHSS QA CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 20

jobs:
  newman_api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install deps
        run: npm ci

      - name: Start mock server
        run: |
          node mock-server.js & echo $! > mock.pid
          for i in {1..40}; do
            curl -fsS http://localhost:3000/health && break
            sleep 1
          done

      - name: Run Newman (API)
        run: |
          mkdir -p artifacts
          npx newman run test_functional/postman/SGHSS_API.postman_collection.json \
            -e test_functional/postman/SGHSS_ENV.json \
            --reporters cli,junitfull \
            --reporter-junitfull-export artifacts/newman.xml

      - name: Upload Newman report
        uses: actions/upload-artifact@v4
        with:
          name: newman-report
          path: artifacts/newman.xml
          if-no-files-found: error

      - name: Stop mock
        if: always()
        run: |
          if [ -f mock.pid ]; then kill -9 $(cat mock.pid) || true; fi

  cypress_ui_a11y:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install deps
        run: npm ci

      - name: Start mock server
        run: |
          node mock-server.js & echo $! > mock.pid
          for i in {1..40}; do
            curl -fsS http://localhost:3000/health && break
            sleep 1
          done

      - name: Run Cypress (UI + A11y)
        env:
          CYPRESS_baseUrl: http://localhost:3000
        run: |
          npx cypress run \
            --config-file "test_functional/cypress/cypress.config.js" \
            --spec "test_functional/cypress/**/*.cy.js,test_accessibility/cypress-axe/**/*.cy.js"

      - name: Upload Cypress videos
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: artifacts/videos
          if-no-files-found: ignore

      - name: Upload Cypress screenshots
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: artifacts/screenshots
          if-no-files-found: ignore

      - name: Stop mock
        if: always()
        run: |
          if [ -f mock.pid ]; then kill -9 $(cat mock.pid) || true; fi

  zap_baseline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install deps
        run: npm ci

      - name: Start mock server
        run: |
          node mock-server.js & echo $! > mock.pid
          for i in {1..40}; do
            curl -fsS http://localhost:3000/health && break
            sleep 1
          done

      - name: ZAP Baseline (warns allowed)
        uses: zaproxy/action-baseline@v0.14.0
        continue-on-error: true
        with:
          target: "http://localhost:3000"
          cmd_options: "-a -m 5"

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: report_html.html
          if-no-files-found: ignore

      - name: Stop mock
        if: always()
        run: |
          if [ -f mock.pid ]; then kill -9 $(cat mock.pid) || true; fi

  locust_smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install deps (for mock)
        run: npm ci

      - name: Start mock server
        run: |
          node mock-server.js & echo $! > mock.pid
          for i in {1..40}; do
            curl -fsS http://localhost:3000/health && break
            sleep 1
          done

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Locust
        run: |
          pip install --upgrade pip
          if [ -f test_performance/locust/requirements.txt ]; then
            pip install -r test_performance/locust/requirements.txt
          else
            pip install locust
          fi

      - name: Run Locust (smoke)
        env:
          PERF_HOST: "http://localhost:3000"
        run: |
          mkdir -p artifacts
          locust -f test_performance/locust/locustfile.py \
            --headless -u 20 -r 5 -t 2m --host "${PERF_HOST}" \
            --csv=artifacts/locust --exit-code-on-error 1 || true

      - name: Upload Locust artifacts
        uses: actions/upload-artifact@v4
        with:
          name: locust-artifacts
          path: artifacts
          if-no-files-found: ignore

      - name: Stop mock
        if: always()
        run: |
          if [ -f mock.pid ]; then kill -9 $(cat mock.pid) || true; fi
          